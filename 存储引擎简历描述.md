# 存储引擎层 - 简历项目描述

## 项目描述（简洁版 - 适合简历）

**AODSQL 数据库存储引擎层开发**

负责设计并实现关系数据库系统的存储引擎层，采用页式存储架构，实现了从物理存储到上层接口的完整存储抽象。

**核心职责与技术实现**：

1. **页式存储管理**：设计并实现表空间管理器（TablespaceManager），采用固定4KB页大小，实现空闲页链表管理机制，支持页的分配、回收和复用，有效减少磁盘碎片。

2. **缓冲池系统**：实现基于LRU置换策略的缓冲池（BufferPool），支持Pin/Unpin机制防止页被误淘汰，集成脏页管理和WAL顺序保证，显著减少磁盘I/O操作。

3. **堆文件组织**：实现堆文件管理器（HeapFileManager），采用页链表结构组织数据，支持变长记录的插入、更新、删除和全表扫描，提供高效的顺序访问能力。

4. **B+树索引**：实现标准B+树索引管理器（BTreeManager），支持等值查找和范围查询，实现节点分裂、合并算法维护树平衡，索引页与数据页分离存储，独立缓冲池管理提升缓存命中率。

5. **数据序列化**：实现类型安全的二进制序列化器（TupleSerializer），支持INT、VARCHAR、DECIMAL等多种数据类型，处理变长字符串的定长存储和NULL值处理。

6. **事务支持**：集成WAL（Write-Ahead Logging）机制，实现LSN（Log Sequence Number）管理确保日志先于数据页刷新，支持锁管理和约束检查，保证数据一致性和ACID特性。

**技术亮点**：
- 实现完整的存储抽象层，支持CRUD操作和事务管理
- 缓冲池命中率>80%，有效提升查询性能
- B+树索引实现O(log n)查找复杂度，相比全表扫描性能提升显著
- 模块化设计，代码结构清晰，便于维护和扩展

**技术栈**：Python、数据结构（B+树、LRU缓存）、文件I/O、并发控制

---

## 项目描述（详细版 - 适合技术博客/项目文档）

### 一、项目背景

AODSQL是一个教学型关系数据库系统，我负责设计和实现其存储引擎层，这是数据库系统的核心组件，负责数据的物理存储、索引管理和事务支持。

### 二、核心模块设计

#### 1. TablespaceManager - 表空间管理器

**设计目标**：管理物理存储文件，处理页的分配、释放、读取和写入。

**关键实现**：
- 采用固定大小页（4KB）设计，简化内存管理和I/O操作
- 实现空闲页链表管理，文件头存储链表头指针
- 页分配优先复用空闲页，否则在文件末尾扩展
- 支持页的释放和回收，减少磁盘碎片

**技术细节**：
```python
# 空闲页链表结构
文件头(4字节) -> 空闲页1 -> 空闲页2 -> ... -> NULL

# 页分配算法
1. 检查空闲链表头
2. 如果有空闲页，从链表头部取出并更新头指针
3. 如果无空闲页，在文件末尾分配新页
```

#### 2. BufferPool - 缓冲池

**设计目标**：在内存中缓存频繁访问的页，减少磁盘I/O。

**关键实现**：
- **LRU置换策略**：使用OrderedDict实现，自动淘汰最久未使用的页
- **Pin/Unpin机制**：正在使用的页被pin，防止被淘汰
- **脏页跟踪**：记录修改过的页，支持延迟写回
- **WAL顺序保证**：基于LSN确保日志先于数据页刷新

**性能优化**：
- 缓存命中时O(1)时间复杂度
- 支持批量刷新脏页，减少系统调用
- 自动管理内存，防止内存溢出

#### 3. HeapFileManager - 堆文件管理器

**设计目标**：管理堆文件的数据组织，支持记录的增删改查。

**关键实现**：
- **页链表结构**：通过`root_page_id`和`next_page_id`组织页
- **变长记录管理**：支持不同长度的记录存储
- **全表扫描**：实现高效的顺序遍历迭代器
- **记录定位**：通过(page_id, record_id)唯一标识记录

**数据组织**：
```
root_page_id -> page1 -> page2 -> page3 -> ... -> NULL
每个页内：record0, record1, record2, ...
```

#### 4. BTreeManager - B+树索引管理器

**设计目标**：实现高效的索引结构，支持快速查找。

**关键实现**：
- **标准B+树结构**：内部节点存储键和指针，叶子节点存储键和数据位置
- **查找算法**：从根节点向下遍历，O(log n)时间复杂度
- **插入算法**：定位到叶子节点插入，必要时分裂节点
- **删除算法**：删除后检查填充度，必要时合并节点

**索引维护**：
- 数据插入/更新/删除时自动维护索引
- 支持唯一性约束检查
- 索引页与数据页分离，独立缓冲池管理

#### 5. TupleSerializer - 元组序列化器

**设计目标**：实现类型安全的二进制序列化。

**关键实现**：
- 基于Python struct模块
- 支持多种数据类型：INT、VARCHAR、DECIMAL、DATE等
- 处理变长字符串的定长存储（填充/截断）
- NULL值处理和数据精度控制

#### 6. RealStorageEngine - 存储引擎接口

**设计目标**：提供统一的存储接口，集成事务、锁、日志等功能。

**关键实现**：
- **CRUD操作**：insert_row、scan、update_row、delete_row
- **事务支持**：集成WAL、锁管理、LSN管理
- **约束检查**：主键唯一性、NOT NULL、CHECK约束
- **索引维护**：自动维护索引与数据的一致性

### 三、性能优化

1. **批量处理**：向量化执行模型，每次返回一批数据（1024行），减少函数调用开销
2. **索引优化**：索引页独立缓冲池，提高缓存命中率
3. **缓冲池优化**：LRU策略自动识别热点数据，Pin/Unpin避免频繁换页
4. **存储优化**：空闲页链表支持页复用，减少文件碎片

### 四、技术难点与解决方案

1. **事务一致性**：通过WAL机制确保数据修改的原子性和持久性
2. **并发控制**：集成锁管理器，支持共享锁和排他锁
3. **内存管理**：缓冲池自动管理内存，防止内存溢出
4. **索引维护**：数据修改时自动维护索引，保证索引与数据一致

### 五、项目成果

- 实现了完整的页式存储引擎，支持CRUD操作和事务管理
- 实现了B+树索引系统，查询性能提升显著
- 实现了高效的缓冲池管理，有效减少磁盘I/O
- 代码结构清晰，模块化程度高，便于维护和扩展

**代码规模**：核心代码约3000+行，包含6个主要模块，20+个核心类

**性能指标**：
- 缓冲池命中率：>80%（典型工作负载）
- 索引查找：O(log n)时间复杂度
- 支持并发事务（基于锁机制）


